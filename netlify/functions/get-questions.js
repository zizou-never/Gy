const { Client } = require('pg');

exports.handler = async (event, context) => {
  // Configuration CORS
    const headers = {
        'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type',
                'Access-Control-Allow-Methods': 'POST, OPTIONS'
                  };

                    // Gérer les requêtes OPTIONS pour CORS
                      if (event.httpMethod === 'OPTIONS') {
                          return {
                                statusCode: 200,
                                      headers,
                                            body: ''
                                                };
                                                  }

                                                    try {
                                                        const client = new Client({
                                                              connectionString: process.env.DATABASE_URL,
                                                                    ssl: {
                                                                            rejectUnauthorized: false
                                                                                  }
                                                                                      });

                                                                                          await client.connect();

                                                                                              const filters = JSON.parse(event.body || '{}');
                                                                                                  
                                                                                                      // Construire la requête SQL avec filtres
                                                                                                          let query = `
                                                                                                                SELECT 
                                                                                                                        q.id,
                                                                                                                                q.question,
                                                                                                                                        q.options,
                                                                                                                                                q.correct_answer as "correctAnswer",
                                                                                                                                                        q.explanation,
                                                                                                                                                                q.year,
                                                                                                                                                                        q.module,
                                                                                                                                                                                q.sub_module as "subModule",
                                                                                                                                                                                        q.difficulty,
                                                                                                                                                                                                q.question_number as "number"
                                                                                                                                                                                                      FROM questions q
                                                                                                                                                                                                            WHERE 1=1
                                                                                                                                                                                                                `;
                                                                                                                                                                                                                    
                                                                                                                                                                                                                        const params = [];
                                                                                                                                                                                                                            let paramIndex = 1;

                                                                                                                                                                                                                                if (filters.module && filters.module !== 'all') {
                                                                                                                                                                                                                                      query += ` AND q.module = $${paramIndex}`;
                                                                                                                                                                                                                                            params.push(filters.module);
                                                                                                                                                                                                                                                  paramIndex++;
                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                          if (filters.year && filters.year !== 'all') {
                                                                                                                                                                                                                                                                query += ` AND q.year = $${paramIndex}`;
                                                                                                                                                                                                                                                                      params.push(filters.year);
                                                                                                                                                                                                                                                                            paramIndex++;
                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                    if (filters.subModule && filters.subModule !== 'all') {
                                                                                                                                                                                                                                                                                          query += ` AND q.sub_module = $${paramIndex}`;
                                                                                                                                                                                                                                                                                                params.push(filters.subModule);
                                                                                                                                                                                                                                                                                                      paramIndex++;
                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                              if (filters.difficulty && filters.difficulty !== 'all') {
                                                                                                                                                                                                                                                                                                                    query += ` AND q.difficulty = $${paramIndex}`;
                                                                                                                                                                                                                                                                                                                          params.push(filters.difficulty);
                                                                                                                                                                                                                                                                                                                                paramIndex++;
                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                        if (filters.search) {
                                                                                                                                                                                                                                                                                                                                              query += ` AND (q.question ILIKE $${paramIndex} OR q.explanation ILIKE $${paramIndex})`;
                                                                                                                                                                                                                                                                                                                                                    params.push(`%${filters.search}%`);
                                                                                                                                                                                                                                                                                                                                                          paramIndex++;
                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                  query += ' ORDER BY q.year DESC, q.question_number ASC';

                                                                                                                                                                                                                                                                                                                                                                      const result = await client.query(query, params);
                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                              await client.end();

                                                                                                                                                                                                                                                                                                                                                                                  return {
                                                                                                                                                                                                                                                                                                                                                                                        statusCode: 200,
                                                                                                                                                                                                                                                                                                                                                                                              headers,
                                                                                                                                                                                                                                                                                                                                                                                                    body: JSON.stringify(result.rows)
                                                                                                                                                                                                                                                                                                                                                                                                        };

                                                                                                                                                                                                                                                                                                                                                                                                          } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                              console.error('Database error:', error);
                                                                                                                                                                                                                                                                                                                                                                                                                  return {
                                                                                                                                                                                                                                                                                                                                                                                                                        statusCode: 500,
                                                                                                                                                                                                                                                                                                                                                                                                                              headers,
                                                                                                                                                                                                                                                                                                                                                                                                                                    body: JSON.stringify({ error: 'Erreur lors de la récupération des questions' })
                                                                                                                                                                                                                                                                                                                                                                                                                                        };
                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                          };